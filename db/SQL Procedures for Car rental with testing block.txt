------------------------------------------------------------
-- PROCEDURE 1: Calculate rental cost
------------------------------------------------------------
CREATE OR REPLACE PROCEDURE proc_calculate_rental_cost (
    p_rental_id IN NUMBER
) AS
    v_days NUMBER;
    v_rate NUMBER;
BEGIN
    SELECT TRUNC(end_date - start_date), c.daily_rate
    INTO v_days, v_rate
    FROM Rentals r JOIN Cars c ON r.car_id = c.car_id
    WHERE r.rental_id = p_rental_id;

    UPDATE Rentals
    SET total_cost = v_days * v_rate
    WHERE rental_id = p_rental_id;

EXCEPTION
    WHEN NO_DATA_FOUND THEN
        DBMS_OUTPUT.PUT_LINE('Rental not found.');
END;
/
------------------------------------------------------------

------------------------------------------------------------
-- PROCEDURE 2: Cancel rental
------------------------------------------------------------
CREATE OR REPLACE PROCEDURE proc_cancel_rental (
    p_rental_id IN NUMBER
) AS
BEGIN
    UPDATE Rentals
    SET status = 'cancelled',
        total_cost = 0
    WHERE rental_id = p_rental_id;

EXCEPTION
    WHEN OTHERS THEN
        DBMS_OUTPUT.PUT_LINE('Error cancelling rental: ' || SQLERRM);
END;
/
------------------------------------------------------------

------------------------------------------------------------
-- TESTING BLOCK
------------------------------------------------------------
-- STEP 1: Insert a rental (USER_ID=1, CAR_ID=1, seq_rental starting at 100)
INSERT INTO Rentals (rental_id, user_id, car_id, start_date, end_date, status, created_at)
VALUES (seq_rental.NEXTVAL, 1, 1, DATE '2025-12-01', DATE '2025-12-05', 'booked', SYSDATE);

-- STEP 2: Call procedure to calculate rental cost
BEGIN
    proc_calculate_rental_cost(100); -- rental_id = 100
END;
/

-- STEP 3: Verify cost updated
SELECT rental_id, total_cost FROM Rentals WHERE rental_id = 100;

-- STEP 4: Call procedure to cancel rental
BEGIN
    proc_cancel_rental(100);
END;
/

-- STEP 5: Verify rental status and cost reset
SELECT rental_id, status, total_cost FROM Rentals WHERE rental_id = 100;

-- STEP 6: Verify car status (Trigger 2 will reset car to 'available')
SELECT car_id, status FROM Cars WHERE car_id = 1;
------------------------------------------------------------